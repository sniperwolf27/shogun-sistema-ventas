<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Pedido - Shogun</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
        .container{max-width:800px;margin:0 auto;background:white;border-radius:16px;padding:36px;box-shadow:0 16px 48px rgba(0,0,0,.25)}
        h1{color:#2F5496;margin-bottom:8px}
        .subtitle{color:#666;margin-bottom:24px}
        .form-section{margin-bottom:28px}
        .form-section h2{color:#5B9BD5;font-size:1.2em;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #e0e0e0}
        .form-group{margin-bottom:18px}
        label{display:block;margin-bottom:6px;font-weight:600;color:#333;font-size:.95em}
        .required{color:#dc3545}
        input,select,textarea{width:100%;padding:11px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;transition:border-color .2s;font-family:inherit}
        input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
        textarea{resize:vertical;min-height:70px}
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .btn-submit{padding:14px 28px;border:none;border-radius:8px;font-size:1.05em;font-weight:600;cursor:pointer;transition:all .2s;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;width:100%}
        .btn-submit:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(102,126,234,.3)}
        .btn-submit:disabled{opacity:.6;cursor:not-allowed;transform:none}
        .alert{padding:14px 18px;border-radius:8px;margin-bottom:18px;display:none}
        .alert-success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
        .alert-danger{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
        .alert.show{display:block}
        .loading{display:none;text-align:center;padding:20px}
        .loading.show{display:block}
        .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:36px;height:36px;animation:spin .8s linear infinite;margin:0 auto 10px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .top-links{display:flex;justify-content:space-between;margin-bottom:20px}
        .top-links a{color:#667eea;text-decoration:none;font-weight:600}
        .price-preview{background:#f8f9fa;padding:16px;border-radius:8px;margin-top:12px;border-left:4px solid #2F5496;display:none}
        .price-row{display:flex;justify-content:space-between;margin-bottom:6px;font-size:.95em}
        .price-total{font-weight:700;font-size:1.1em;border-top:2px solid #e0e0e0;padding-top:8px;margin-top:8px}
        .access-denied{text-align:center;padding:60px 20px}
        .access-denied i{font-size:4em;color:#dc3545;display:block;margin-bottom:16px}
        .back-btn{display:inline-block;margin-top:20px;padding:12px 24px;background:#2F5496;color:white;border-radius:8px;text-decoration:none;font-weight:600}
        @media(max-width:768px){.form-grid{grid-template-columns:1fr}.container{padding:20px}}
    </style>
</head>
<body>
<div class="container">
    <!-- Access denied screen -->
    <div id="accessDenied" class="access-denied" style="display:none;">
        <i class="fas fa-lock"></i>
        <h2>Acceso Denegado</h2>
        <p style="color:#666;margin-top:8px;">Solo administradores pueden crear pedidos.</p>
        <a href="/backoffice" class="back-btn">Ir al Backoffice</a>
    </div>

    <!-- Form container -->
    <div id="formContainer">
        <div class="top-links">
            <a href="/backoffice"><i class="fas fa-arrow-left"></i> Volver al Backoffice</a>
        </div>

        <h1>üì¶ Nuevo Pedido</h1>
        <p class="subtitle">Los datos se guardan directamente en la base de datos</p>

        <div id="alertSuccess" class="alert alert-success"></div>
        <div id="alertError" class="alert alert-danger"></div>
        <div id="loading" class="loading"><div class="spinner"></div><p>Guardando pedido...</p></div>

        <form id="formPedido">
            <!-- Producto -->
            <div class="form-section">
                <h2>üëï Producto</h2>
                <div class="form-group">
                    <label>Producto <span class="required">*</span></label>
                    <select id="producto" required><option value="">Cargando productos...</option></select>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Talla <span class="required">*</span></label>
                        <select id="talla" required>
                            <option value="">Seleccionar...</option>
                            <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>XXL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Personalizaci√≥n</label>
                        <select id="personalizacion"><option value="ninguna">Ninguna</option></select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Detalles de personalizaci√≥n</label>
                    <textarea id="detalles" placeholder="Ej: Logo empresa en el frente"></textarea>
                </div>
            </div>

            <!-- Cliente -->
            <div class="form-section">
                <h2>üë§ Cliente</h2>
                <div class="form-group">
                    <label>Nombre completo <span class="required">*</span></label>
                    <input type="text" id="cliente" required placeholder="Juan P√©rez">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tel√©fono <span class="required">*</span></label>
                        <input type="tel" id="telefono" required placeholder="809-555-0000">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" placeholder="juan@email.com">
                    </div>
                </div>
                <div class="form-group">
                    <label>Direcci√≥n de env√≠o <span class="required">*</span></label>
                    <textarea id="direccion" required placeholder="Calle, n√∫mero, sector, ciudad"></textarea>
                </div>
                <div class="form-group">
                    <label>Canal de venta <span class="required">*</span></label>
                    <select id="canal" required>
                        <option value="">Seleccionar...</option>
                        <option>WhatsApp</option><option>Instagram</option><option>Facebook</option><option>Referido</option><option>Tienda</option>
                    </select>
                </div>
            </div>

            <!-- Pago -->
            <div class="form-section">
                <h2>üí≥ Pago</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>M√©todo de pago <span class="required">*</span></label>
                        <select id="banco" required>
                            <option value="">Seleccionar...</option>
                            <option>Popular</option><option>Banreservas</option><option>BHD</option><option>Efectivo</option><option>Transferencia</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estado del pago <span class="required">*</span></label>
                        <select id="estatusPago" required>
                            <option>Recibido</option><option>Pendiente</option><option>Parcial</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Costo de env√≠o (RD$)</label>
                    <input type="number" id="costoEnvio" value="200" min="0">
                </div>

                <!-- Price preview -->
                <div class="price-preview" id="pricePreview">
                    <div class="price-row"><span>Producto:</span><span id="prevProducto">RD$0</span></div>
                    <div class="price-row"><span>Personalizaci√≥n:</span><span id="prevPers">RD$0</span></div>
                    <div class="price-row"><span>Env√≠o:</span><span id="prevEnvio">RD$200</span></div>
                    <div class="price-row price-total"><span>Total estimado:</span><span id="prevTotal">RD$0</span></div>
                </div>
            </div>

            <button type="submit" class="btn-submit" id="btnSubmit">üíæ Guardar Pedido</button>
        </form>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/config.js"></script>
<script>
(async function() {
    // --- Auth check ---
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    let currentToken = localStorage.getItem('sb_access_token');

    if (!currentToken || !user) {
        window.location.href = '/login';
        return;
    }

    if (user.rol !== 'admin') {
        document.getElementById('formContainer').style.display = 'none';
        document.getElementById('accessDenied').style.display = 'block';
        return;
    }

    // Try to refresh token via Supabase SDK
    try {
        const sb = window.initSupabase();
        if (sb) {
            const refreshToken = localStorage.getItem('sb_refresh_token');
            if (refreshToken) {
                const { data, error } = await sb.auth.setSession({
                    access_token: currentToken,
                    refresh_token: refreshToken
                });
                if (data && data.session) {
                    currentToken = data.session.access_token;
                    localStorage.setItem('sb_access_token', data.session.access_token);
                    if (data.session.refresh_token) {
                        localStorage.setItem('sb_refresh_token', data.session.refresh_token);
                    }
                }
            }
        }
    } catch(e) {
        console.warn('Token refresh failed:', e);
    }

    // --- API helper (always reads fresh token) ---
    function getToken() {
        return localStorage.getItem('sb_access_token') || currentToken;
    }

    async function apiFetch(endpoint, options = {}) {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken(),
            ...(options.headers || {})
        };
        const res = await fetch(API_BASE + endpoint, { ...options, headers });
        if (res.status === 401) { window.location.href = '/login'; return null; }
        if (res.status === 403) { throw new Error('Sin permisos para esta acci√≥n'); }
        return res.json();
    }

    // --- Load catalog from DB ---
    let productosData = [];
    let persData = [];

    async function loadCatalog() {
        try {
            productosData = await apiFetch('/productos') || [];
            persData = await apiFetch('/personalizaciones') || [];

            const prodSelect = document.getElementById('producto');
            prodSelect.innerHTML = '<option value="">Seleccionar producto...</option>' +
                productosData.map(p =>
                    `<option value="${p.sku}" data-precio="${p.precio_base}" data-nombre="${p.nombre}" data-dias="${p.tiempo_produccion_dias}">${p.nombre} ‚Äî RD$${Number(p.precio_base).toLocaleString()}</option>`
                ).join('');

            const persSelect = document.getElementById('personalizacion');
            persSelect.innerHTML = '<option value="ninguna">Ninguna</option>' +
                persData.map(p =>
                    `<option value="${p.codigo}" data-precio="${p.precio}">${p.tipo} (+RD$${Number(p.precio).toLocaleString()})</option>`
                ).join('');
        } catch (e) {
            console.error('Error cargando cat√°logo:', e);
            showError('Error al cargar el cat√°logo de productos');
        }
    }

    loadCatalog();

    // --- Price preview ---
    function updatePreview() {
        const prodOpt = document.getElementById('producto').selectedOptions[0];
        const persOpt = document.getElementById('personalizacion').selectedOptions[0];
        const envio = parseInt(document.getElementById('costoEnvio').value) || 0;

        const precioProd = parseFloat(prodOpt?.dataset?.precio || 0);
        const precioPers = parseFloat(persOpt?.dataset?.precio || 0);
        const total = precioProd + precioPers + envio;

        document.getElementById('prevProducto').textContent = 'RD$' + precioProd.toLocaleString();
        document.getElementById('prevPers').textContent = 'RD$' + precioPers.toLocaleString();
        document.getElementById('prevEnvio').textContent = 'RD$' + envio.toLocaleString();
        document.getElementById('prevTotal').textContent = 'RD$' + total.toLocaleString();
        document.getElementById('pricePreview').style.display = precioProd > 0 ? 'block' : 'none';
    }

    document.getElementById('producto').addEventListener('change', updatePreview);
    document.getElementById('personalizacion').addEventListener('change', updatePreview);
    document.getElementById('costoEnvio').addEventListener('input', updatePreview);

    // --- Alert helpers ---
    function showSuccess(msg) {
        const el = document.getElementById('alertSuccess');
        el.innerHTML = msg;
        el.classList.add('show');
        document.getElementById('alertError').classList.remove('show');
    }

    function showError(msg) {
        const el = document.getElementById('alertError');
        el.innerHTML = msg;
        el.classList.add('show');
        document.getElementById('alertSuccess').classList.remove('show');
    }

    function hideAlerts() {
        document.getElementById('alertSuccess').classList.remove('show');
        document.getElementById('alertError').classList.remove('show');
    }

    // --- Submit ---
    document.getElementById('formPedido').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideAlerts();

        const prodOpt = document.getElementById('producto').selectedOptions[0];
        if (!prodOpt || !prodOpt.value) {
            showError('Selecciona un producto');
            return;
        }

        const formData = {
            producto_sku: document.getElementById('producto').value,
            producto_nombre: prodOpt.dataset.nombre || '',
            talla: document.getElementById('talla').value,
            personalizacion_tipo: document.getElementById('personalizacion').value,
            personalizacion_detalles: document.getElementById('detalles').value.trim(),
            nombre_cliente: document.getElementById('cliente').value.trim(),
            telefono: document.getElementById('telefono').value.trim(),
            email: document.getElementById('email').value.trim(),
            direccion: document.getElementById('direccion').value.trim(),
            canal: document.getElementById('canal').value,
            banco: document.getElementById('banco').value,
            estatus_pago: document.getElementById('estatusPago').value,
            costo_envio: document.getElementById('costoEnvio').value || '200',
            tiempo_estimado: (prodOpt.dataset.dias || '7') + ' d√≠as'
        };

        // Validate required
        const required = ['producto_sku', 'talla', 'nombre_cliente', 'telefono', 'direccion', 'canal', 'banco'];
        for (const field of required) {
            if (!formData[field]) {
                showError('Completa todos los campos obligatorios');
                return;
            }
        }

        const btn = document.getElementById('btnSubmit');
        btn.disabled = true;
        document.getElementById('loading').classList.add('show');

        try {
            const result = await apiFetch('/pedidos', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            document.getElementById('loading').classList.remove('show');

            if (result && result.success) {
                showSuccess(`
                    ‚úÖ <strong>Pedido ${result.pedido_id} creado exitosamente!</strong><br>
                    Total estimado en base de datos.
                `);
                document.getElementById('formPedido').reset();
                document.getElementById('pricePreview').style.display = 'none';
                window.scrollTo(0, 0);
            } else {
                throw new Error(result?.error || 'Error desconocido');
            }
        } catch (error) {
            document.getElementById('loading').classList.remove('show');
            showError(`‚ùå <strong>Error:</strong> ${error.message}`);
            window.scrollTo(0, 0);
        } finally {
            btn.disabled = false;
        }
    });
})();
</script>
</body>
</html>
