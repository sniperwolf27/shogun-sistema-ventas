<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Pedido - Shogun</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
        .container{max-width:800px;margin:0 auto;background:white;border-radius:16px;padding:36px;box-shadow:0 16px 48px rgba(0,0,0,.25)}
        h1{color:#2F5496;margin-bottom:8px}
        .subtitle{color:#666;margin-bottom:24px}
        .form-section{margin-bottom:28px}
        .form-section h2{color:#5B9BD5;font-size:1.2em;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #e0e0e0}
        .form-group{margin-bottom:18px}
        label{display:block;margin-bottom:6px;font-weight:600;color:#333;font-size:.95em}
        .required{color:#dc3545}
        input,select,textarea{width:100%;padding:11px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;transition:border-color .2s;font-family:inherit}
        input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
        textarea{resize:vertical;min-height:70px}
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
        .btn-submit{padding:14px 28px;border:none;border-radius:8px;font-size:1.05em;font-weight:600;cursor:pointer;transition:all .2s;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;width:100%}
        .btn-submit:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(102,126,234,.3)}
        .btn-submit:disabled{opacity:.6;cursor:not-allowed;transform:none}
        .alert{padding:14px 18px;border-radius:8px;margin-bottom:18px;display:none}
        .alert-success{background:#d4edda;color:#155724;border-left:4px solid #28a745}
        .alert-danger{background:#f8d7da;color:#721c24;border-left:4px solid #dc3545}
        .alert.show{display:block}
        .loading{display:none;text-align:center;padding:20px}
        .loading.show{display:block}
        .spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:36px;height:36px;animation:spin .8s linear infinite;margin:0 auto 10px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .top-links{display:flex;justify-content:space-between;margin-bottom:20px}
        .top-links a{color:#667eea;text-decoration:none;font-weight:600}
        .price-preview{background:#f8f9fa;padding:16px;border-radius:8px;margin-top:12px;border-left:4px solid #2F5496;display:none}
        .price-row{display:flex;justify-content:space-between;margin-bottom:6px;font-size:.95em}
        .price-total{font-weight:700;font-size:1.1em;border-top:2px solid #e0e0e0;padding-top:8px;margin-top:8px}
        .access-denied{text-align:center;padding:60px 20px}
        .access-denied i{font-size:4em;color:#dc3545;display:block;margin-bottom:16px}
        .back-btn{display:inline-block;margin-top:20px;padding:12px 24px;background:#2F5496;color:white;border-radius:8px;text-decoration:none;font-weight:600}
        @media(max-width:768px){.form-grid{grid-template-columns:1fr}.container{padding:20px}#stickyResumen{margin:0 -20px -20px !important;border-radius:0 !important;}}
        .field-error { border-color: #dc3545 !important; box-shadow: 0 0 0 3px rgba(220,53,69,.12) !important; }
        .field-error-label { color: #dc3545; font-size: .8em; margin-top: 4px; }
    </style>
</head>
<body>
<div class="container">
    <!-- Access denied screen -->
    <div id="accessDenied" class="access-denied" style="display:none;">
        <i class="fas fa-lock"></i>
        <h2>Acceso Denegado</h2>
        <p style="color:#666;margin-top:8px;">Solo administradores pueden crear pedidos.</p>
        <a href="/backoffice" class="back-btn">Ir al Backoffice</a>
    </div>

    <!-- Form container -->
    <div id="formContainer">
        <div class="top-links">
            <a href="/backoffice"><i class="fas fa-arrow-left"></i> Volver al Backoffice</a>
        </div>

        <h1>üì¶ Nuevo Pedido</h1>
        <p class="subtitle">Los datos se guardan directamente en la base de datos</p>

        <div id="alertSuccess" class="alert alert-success"></div>
        <div id="alertError" class="alert alert-danger"></div>
        <div id="loading" class="loading"><div class="spinner"></div><p>Guardando pedido...</p></div>

        <form id="formPedido">
            <!-- Producto -->
            <div class="form-section">
                <h2>üëï Producto</h2>
                <div class="form-group">
                    <label>Producto <span class="required">*</span></label>
                    <select id="producto" required><option value="">Cargando productos...</option></select>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Talla <span class="required">*</span></label>
                        <select id="talla" required>
                            <option value="">Seleccionar...</option>
                            <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>XXL</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Color</label>
                        <input type="text" id="color" placeholder="Ej: Negro, Blanco, Rojo" list="coloresList">
                        <datalist id="coloresList">
                            <option value="Negro">
                            <option value="Blanco">
                            <option value="Gris">
                            <option value="Azul">
                            <option value="Rojo">
                            <option value="Verde">
                            <option value="Beige">
                        </datalist>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Personalizaci√≥n</label>
                        <select id="personalizacion"><option value="ninguna">Ninguna</option></select>
                    </div>
                    <div class="form-group" id="puntadasGroup" style="display:none;">
                        <label>Cantidad de Puntadas <span class="required">*</span></label>
                        <input type="number" id="puntadas" placeholder="Ej: 36000" min="0">
                        <div id="puntadasCalc" style="font-size:.85em;color:#6f42c1;margin-top:4px;"></div>
                    </div>
                </div>
                <!-- Precio de venta y costos adicionales (siempre visibles) -->
                <div class="form-grid">
                    <div class="form-group">
                        <label>Precio de Venta al Cliente (RD$) <span class="required">*</span></label>
                        <input type="number" id="precioVenta" placeholder="Ej: 1500" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Costos Adicionales (RD$)</label>
                        <input type="number" id="costosAdicionales" placeholder="0" min="0" value="0">
                    </div>
                </div>
                <!-- Resumen financiero (visible cuando hay datos) -->
                <div id="bordadoResumen" style="background:#f0f4ff;padding:14px;border-radius:8px;border-left:4px solid #6f42c1;margin-bottom:14px;display:none;">
                    <div style="font-size:.85em;font-weight:600;color:#555;margin-bottom:8px;">üìä Resumen Financiero</div>
                    <div style="font-size:.88em;color:#333;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Costo prenda:</span><span id="resCostoPrenda">RD$0</span></div>
                        <div id="resManoObraRow" style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Mano de obra:</span><span id="resManoObra">RD$0</span></div>
                        <div id="resCostosAdRow" style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Costos adicionales:</span><span id="resCostosAd">RD$0</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;border-top:1px solid #ddd;padding-top:4px;font-weight:600;"><span>Costo total:</span><span id="resCostoTotal">RD$0</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;font-weight:700;color:#28a745;"><span>Ganancia neta:</span><span id="resGanancia">RD$0</span></div>
                        <div style="display:flex;justify-content:space-between;font-weight:700;color:#6f42c1;"><span>Margen:</span><span id="resMargen">0%</span></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Detalles de personalizaci√≥n</label>
                    <textarea id="detalles" placeholder="Ej: Logo empresa en el frente"></textarea>
                </div>
            </div>

            <!-- Cliente -->
            <div class="form-section">
                <h2>üë§ Cliente</h2>
                <div class="form-group">
                    <label>Nombre completo <span class="required">*</span></label>
                    <input type="text" id="cliente" required placeholder="Juan P√©rez">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tel√©fono <span class="required">*</span></label>
                        <input type="tel" id="telefono" required placeholder="809-555-0000">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" placeholder="juan@email.com">
                    </div>
                </div>
                <div class="form-group">
                    <label>Direcci√≥n de env√≠o <span class="required">*</span></label>
                    <textarea id="direccion" required placeholder="Calle, n√∫mero, sector, ciudad"></textarea>
                </div>
                <div class="form-group">
                    <label>Canal de venta <span class="required">*</span></label>
                    <select id="canal" required>
                        <option value="">Seleccionar...</option>
                        <option>WhatsApp</option><option>Instagram</option><option>Facebook</option><option>Referido</option><option>Tienda</option>
                    </select>
                </div>
            </div>

            <!-- Pago -->
            <div class="form-section">
                <h2>üí≥ Pago</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>M√©todo de pago <span class="required">*</span></label>
                        <select id="banco" required>
                            <option value="">Seleccionar...</option>
                            <option>Popular</option><option>Banreservas</option><option>BHD</option><option>Efectivo</option><option>Transferencia</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estado del pago <span class="required">*</span></label>
                        <select id="estatusPago" required>
                            <option>Recibido</option><option>Pendiente</option><option>Parcial</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Costo de env√≠o (RD$)</label>
                    <input type="number" id="costoEnvio" value="200" min="0">
                </div>

                <!-- Price preview -->
                <div class="price-preview" id="pricePreview">
                    <div class="price-row"><span>Precio venta:</span><span id="prevProducto">RD$0</span></div>
                    <div class="price-row"><span>Env√≠o:</span><span id="prevEnvio">RD$200</span></div>
                    <div class="price-row price-total"><span>Total al cliente:</span><span id="prevTotal">RD$0</span></div>
                </div>
            </div>

            <button type="submit" class="btn-submit" id="btnSubmit">üíæ Guardar Pedido</button>
        </form>

        <!-- Sticky bottom summary bar -->
        <div id="stickyResumen" style="display:none;position:sticky;bottom:0;background:white;border-top:2px solid #e0e0e0;padding:12px 16px;margin:0 -36px -36px;border-radius:0 0 16px 16px;z-index:10;box-shadow:0 -4px 12px rgba(0,0,0,.06);">
            <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                <div style="font-size:.9em;color:#555;">
                    <strong id="stickyProducto" style="color:#2F5496;">‚Äî</strong>
                    <span id="stickyCliente" style="margin-left:8px;">‚Äî</span>
                </div>
                <div style="font-weight:700;color:#2F5496;font-size:1.15em;" id="stickyTotal">RD$0</div>
            </div>
        </div>

        <!-- Post-creation: Comments & Attachments -->
        <div id="postCreationSection" style="display:none;margin-top:28px;padding-top:24px;border-top:3px solid #667eea;">
            <h2 style="color:#2F5496;font-size:1.3em;margin-bottom:16px;">üìé Adjuntos y Comentarios ‚Äî <span id="postPedidoId"></span></h2>

            <!-- Adjuntos -->
            <div style="margin-bottom:20px;">
                <label style="font-size:.95em;font-weight:600;display:flex;align-items:center;gap:6px;margin-bottom:8px;"><i class="fas fa-paperclip" style="color:#667eea;"></i> Adjuntos</label>
                <div id="postAdjuntosLista" style="margin-bottom:10px;"><p style="color:#999;font-size:.9em;">Sin adjuntos</p></div>
                <div style="display:flex;gap:8px;align-items:center;">
                    <input type="file" id="postAdjuntoInput" style="display:none;" multiple>
                    <button type="button" class="btn-submit" style="width:auto;padding:10px 18px;font-size:.9em;" id="btnPostAddFile"><i class="fas fa-upload"></i> Subir archivo</button>
                    <span id="postAdjuntoStatus" style="font-size:.85em;color:#666;"></span>
                </div>
            </div>

            <!-- Comentarios -->
            <div>
                <label style="font-size:.95em;font-weight:600;display:flex;align-items:center;gap:6px;margin-bottom:8px;"><i class="fas fa-comments" style="color:#667eea;"></i> Comentarios</label>
                <div id="postComentariosLista" style="margin-bottom:10px;"><p style="color:#999;font-size:.9em;">Sin comentarios</p></div>
                <div style="display:flex;gap:8px;">
                    <input id="postNuevoComentario" placeholder="Escribe un comentario..." style="flex:1;padding:11px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:1em;">
                    <button type="button" class="btn-submit" style="width:auto;padding:10px 18px;font-size:.9em;" id="btnPostAddComment"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/config.js"></script>
<script>
(async function() {
    // --- Auth check ---
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    let currentToken = localStorage.getItem('sb_access_token');

    if (!currentToken || !user) {
        window.location.href = '/login';
        return;
    }

    if (user.rol !== 'admin') {
        document.getElementById('formContainer').style.display = 'none';
        document.getElementById('accessDenied').style.display = 'block';
        return;
    }

    // Try to refresh token via Supabase SDK
    try {
        const sb = window.initSupabase();
        if (sb) {
            const refreshToken = localStorage.getItem('sb_refresh_token');
            if (refreshToken) {
                const { data, error } = await sb.auth.setSession({
                    access_token: currentToken,
                    refresh_token: refreshToken
                });
                if (data && data.session) {
                    currentToken = data.session.access_token;
                    localStorage.setItem('sb_access_token', data.session.access_token);
                    if (data.session.refresh_token) {
                        localStorage.setItem('sb_refresh_token', data.session.refresh_token);
                    }
                }
            }
        }
    } catch(e) {
        console.warn('Token refresh failed:', e);
    }

    // --- API helper (always reads fresh token) ---
    function getToken() {
        return localStorage.getItem('sb_access_token') || currentToken;
    }

    async function apiFetch(endpoint, options = {}) {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken(),
            ...(options.headers || {})
        };
        const res = await fetch(API_BASE + endpoint, { ...options, headers });
        if (res.status === 401) { window.location.href = '/login'; return null; }
        if (res.status === 403) { throw new Error('Sin permisos para esta acci√≥n'); }
        return res.json();
    }

    // --- Load catalog from DB ---
    let productosData = [];
    let persData = [];

    async function loadCatalog() {
        try {
            productosData = await apiFetch('/productos') || [];
            persData = await apiFetch('/personalizaciones') || [];

            const prodSelect = document.getElementById('producto');
            prodSelect.innerHTML = '<option value="">Seleccionar producto...</option>' +
                productosData.map(p =>
                    `<option value="${p.sku}" data-precio="${p.precio_base}" data-costo-material="${p.costo_material || 0}" data-nombre="${p.nombre}" data-dias="${p.tiempo_produccion_dias}">${p.nombre}</option>`
                ).join('');

            const persSelect = document.getElementById('personalizacion');
            persSelect.innerHTML = '<option value="ninguna">Ninguna</option>' +
                persData.map(p => {
                    const label = p.metodo_calculo === 'puntadas'
                        ? `${p.tipo} (Bordado ‚Äî RD$${Number(p.costo_por_mil_puntadas||0).toLocaleString()}/1K punt.)`
                        : `${p.tipo} (+RD$${Number(p.precio).toLocaleString()})`;
                    return `<option value="${p.codigo}" data-precio="${p.precio}" data-metodo="${p.metodo_calculo||'fijo'}" data-costo-mil="${p.costo_por_mil_puntadas||0}">${label}</option>`;
                }).join('');
        } catch (e) {
            console.error('Error cargando cat√°logo:', e);
            showError('Error al cargar el cat√°logo de productos');
        }
    }

    loadCatalog();

    // --- Show/hide puntadas based on personalizaci√≥n ---
    let isBordadoMode = false;

    function handlePersChange() {
        const persOpt = document.getElementById('personalizacion').selectedOptions[0];
        const metodo = persOpt?.dataset?.metodo || 'fijo';
        const puntadasGrp = document.getElementById('puntadasGroup');

        isBordadoMode = (metodo === 'puntadas');

        if (isBordadoMode) {
            puntadasGrp.style.display = 'block';
        } else {
            puntadasGrp.style.display = 'none';
            document.getElementById('puntadas').value = '';
            document.getElementById('puntadasCalc').textContent = '';
        }
        updatePreview();
    }

    // --- Price preview (siempre basado en precioVenta) ---
    function updatePreview() {
        const prodOpt = document.getElementById('producto').selectedOptions[0];
        const persOpt = document.getElementById('personalizacion').selectedOptions[0];
        const envio = parseInt(document.getElementById('costoEnvio').value) || 0;
        const puntadas = parseInt(document.getElementById('puntadas').value) || 0;
        const precioVenta = parseFloat(document.getElementById('precioVenta').value) || 0;
        const costosAd = parseFloat(document.getElementById('costosAdicionales').value) || 0;

        const costoMat = parseFloat(prodOpt?.dataset?.costoMaterial || 0);
        const costoMil = parseFloat(persOpt?.dataset?.costoMil || 0);

        // Mano de obra (solo si hay puntadas/bordado)
        const manoObra = (isBordadoMode && puntadas > 0 && costoMil > 0)
            ? (puntadas / 1000) * costoMil : 0;

        // Puntadas calc label
        const calcEl = document.getElementById('puntadasCalc');
        if (calcEl) {
            calcEl.textContent = (isBordadoMode && puntadas > 0)
                ? `${(puntadas/1000).toFixed(1)} mil √ó RD$${costoMil.toLocaleString()} = RD$${manoObra.toLocaleString()}`
                : '';
        }

        // Costos y ganancia
        const costoTotal = costoMat + manoObra + costosAd;
        const ganancia = precioVenta - costoTotal;
        const margen = precioVenta > 0 ? (ganancia / precioVenta * 100) : 0;

        // Resumen financiero
        const resumen = document.getElementById('bordadoResumen');
        if (precioVenta > 0 && costoMat > 0) {
            resumen.style.display = 'block';
            document.getElementById('resCostoPrenda').textContent = 'RD$' + costoMat.toLocaleString();
            document.getElementById('resManoObra').textContent = 'RD$' + manoObra.toLocaleString();
            document.getElementById('resManoObraRow').style.display = manoObra > 0 ? 'flex' : 'none';
            document.getElementById('resCostosAd').textContent = 'RD$' + costosAd.toLocaleString();
            document.getElementById('resCostosAdRow').style.display = costosAd > 0 ? 'flex' : 'none';
            document.getElementById('resCostoTotal').textContent = 'RD$' + costoTotal.toLocaleString();
            document.getElementById('resGanancia').textContent = 'RD$' + ganancia.toLocaleString();
            document.getElementById('resGanancia').style.color = ganancia >= 0 ? '#28a745' : '#dc3545';
            document.getElementById('resMargen').textContent = margen.toFixed(1) + '%';
            document.getElementById('resMargen').style.color = margen >= 0 ? '#6f42c1' : '#dc3545';
        } else {
            resumen.style.display = 'none';
        }

        // Preview total al cliente
        const total = precioVenta + envio;
        document.getElementById('prevProducto').textContent = 'RD$' + precioVenta.toLocaleString();
        document.getElementById('prevEnvio').textContent = 'RD$' + envio.toLocaleString();
        document.getElementById('prevTotal').textContent = 'RD$' + total.toLocaleString();
        document.getElementById('pricePreview').style.display = precioVenta > 0 ? 'block' : 'none';
    }

    document.getElementById('producto').addEventListener('change', updatePreview);
    document.getElementById('personalizacion').addEventListener('change', handlePersChange);
    document.getElementById('costoEnvio').addEventListener('input', updatePreview);
    document.getElementById('puntadas').addEventListener('input', updatePreview);
    document.getElementById('precioVenta').addEventListener('input', updatePreview);
    document.getElementById('costosAdicionales').addEventListener('input', updatePreview);

    // --- Alert helpers ---
    function showSuccess(msg) {
        const el = document.getElementById('alertSuccess');
        el.innerHTML = msg;
        el.classList.add('show');
        document.getElementById('alertError').classList.remove('show');
    }

    function showError(msg) {
        const el = document.getElementById('alertError');
        el.innerHTML = msg;
        el.classList.add('show');
        document.getElementById('alertSuccess').classList.remove('show');
    }

    function hideAlerts() {
        document.getElementById('alertSuccess').classList.remove('show');
        document.getElementById('alertError').classList.remove('show');
    }

    // --- Field mapping for validation ---
    const fieldMap = {
        producto_sku: { el: 'producto', label: 'Producto' },
        talla: { el: 'talla', label: 'Talla' },
        precio_venta: { el: 'precioVenta', label: 'Precio de Venta' },
        nombre_cliente: { el: 'cliente', label: 'Nombre del cliente' },
        telefono: { el: 'telefono', label: 'Tel√©fono' },
        direccion: { el: 'direccion', label: 'Direcci√≥n' },
        canal: { el: 'canal', label: 'Canal de venta' },
        banco: { el: 'banco', label: 'M√©todo de pago' }
    };

    function clearFieldErrors() {
        document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
        document.querySelectorAll('.field-error-label').forEach(el => el.remove());
    }

    function markFieldError(inputId, message) {
        const el = document.getElementById(inputId);
        if (!el) return null;
        el.classList.add('field-error');
        // Add error label below
        let errLabel = el.parentElement.querySelector('.field-error-label');
        if (!errLabel) {
            errLabel = document.createElement('div');
            errLabel.className = 'field-error-label';
            el.parentElement.appendChild(errLabel);
        }
        errLabel.textContent = message;
        return el;
    }

    // --- Update sticky summary bar ---
    function updateSticky() {
        const sticky = document.getElementById('stickyResumen');
        const prodOpt = document.getElementById('producto').selectedOptions[0];
        const precioVenta = parseFloat(document.getElementById('precioVenta').value) || 0;
        const envio = parseInt(document.getElementById('costoEnvio').value) || 0;
        const cliente = document.getElementById('cliente').value.trim();

        const hasData = (prodOpt && prodOpt.value) || precioVenta > 0 || cliente;
        sticky.style.display = hasData ? 'block' : 'none';

        document.getElementById('stickyProducto').textContent = (prodOpt && prodOpt.value) ? (prodOpt.dataset.nombre || prodOpt.textContent) : '‚Äî';
        document.getElementById('stickyCliente').textContent = cliente ? '¬∑ ' + cliente : '';
        document.getElementById('stickyTotal').textContent = precioVenta > 0 ? 'RD$' + (precioVenta + envio).toLocaleString() : 'RD$0';
    }

    // Hook sticky updates to relevant fields
    ['producto', 'precioVenta', 'costoEnvio', 'cliente'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'input', updateSticky);
    });

    // Clear field errors on user interaction
    document.querySelectorAll('#formPedido input, #formPedido select, #formPedido textarea').forEach(el => {
        const evt = (el.tagName === 'SELECT') ? 'change' : 'input';
        el.addEventListener(evt, () => {
            el.classList.remove('field-error');
            const errLabel = el.parentElement.querySelector('.field-error-label');
            if (errLabel) errLabel.remove();
        });
    });

    // --- Progressive hiding: hide personalizaci√≥n details when 'Ninguna' ---
    const persDetailsGroup = document.getElementById('detalles').closest('.form-group');
    function updatePersVisibility() {
        const persVal = document.getElementById('personalizacion').value;
        const isNinguna = !persVal || persVal === 'ninguna';
        if (persDetailsGroup) persDetailsGroup.style.display = isNinguna ? 'none' : 'block';
    }
    document.getElementById('personalizacion').addEventListener('change', updatePersVisibility);
    // Run once on load
    setTimeout(updatePersVisibility, 500);

    // --- Submit ---
    document.getElementById('formPedido').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideAlerts();
        clearFieldErrors();

        const prodOpt = document.getElementById('producto').selectedOptions[0];
        if (!prodOpt || !prodOpt.value) {
            markFieldError('producto', 'Selecciona un producto');
            document.getElementById('producto').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('producto').focus();
            showError('Selecciona un producto');
            return;
        }

        const formData = {
            producto_sku: document.getElementById('producto').value,
            producto_nombre: prodOpt.dataset.nombre || '',
            talla: document.getElementById('talla').value,
            color: document.getElementById('color').value.trim(),
            personalizacion_tipo: document.getElementById('personalizacion').value,
            personalizacion_detalles: document.getElementById('detalles').value.trim(),
            personalizacion_puntadas: parseInt(document.getElementById('puntadas').value) || 0,
            costo_por_mil_puntadas: parseFloat(document.getElementById('personalizacion').selectedOptions[0]?.dataset?.costoMil || 0),
            precio_venta: parseFloat(document.getElementById('precioVenta').value) || 0,
            costos_adicionales: parseFloat(document.getElementById('costosAdicionales').value) || 0,
            nombre_cliente: document.getElementById('cliente').value.trim(),
            telefono: document.getElementById('telefono').value.trim(),
            email: document.getElementById('email').value.trim(),
            direccion: document.getElementById('direccion').value.trim(),
            canal: document.getElementById('canal').value,
            banco: document.getElementById('banco').value,
            estatus_pago: document.getElementById('estatusPago').value,
            costo_envio: document.getElementById('costoEnvio').value || '200',
            tiempo_estimado: (prodOpt.dataset.dias || '7') + ' d√≠as'
        };

        // Validate required with scroll-to-error
        const required = ['producto_sku', 'talla', 'precio_venta', 'nombre_cliente', 'telefono', 'direccion', 'canal', 'banco'];
        for (const field of required) {
            if (!formData[field]) {
                const mapping = fieldMap[field];
                if (mapping) {
                    const el = markFieldError(mapping.el, `${mapping.label} es requerido`);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        el.focus();
                    }
                    showError(`Campo requerido: <strong>${mapping.label}</strong>`);
                } else {
                    showError('Completa todos los campos obligatorios');
                }
                return;
            }
        }

        const btn = document.getElementById('btnSubmit');
        btn.disabled = true;
        document.getElementById('loading').classList.add('show');

        try {
            const result = await apiFetch('/pedidos', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            document.getElementById('loading').classList.remove('show');

            if (result && result.success) {
                showSuccess(`
                    ‚úÖ <strong>Pedido ${result.pedido_id} creado exitosamente!</strong><br>
                    Total estimado en base de datos.
                `);
                document.getElementById('formPedido').reset();
                document.getElementById('pricePreview').style.display = 'none';
                document.getElementById('bordadoResumen').style.display = 'none';
                document.getElementById('stickyResumen').style.display = 'none';
                document.getElementById('puntadasGroup').style.display = 'none';
                clearFieldErrors();
                updatePersVisibility();
                window.scrollTo(0, 0);

                // Show post-creation section
                showPostCreation(result.pedido_id);
            } else {
                throw new Error(result?.error || 'Error desconocido');
            }
        } catch (error) {
            document.getElementById('loading').classList.remove('show');
            showError(`‚ùå <strong>Error:</strong> ${error.message}`);
            window.scrollTo(0, 0);
        } finally {
            btn.disabled = false;
        }
    });

    // ========== POST-CREATION: Comments & Attachments ==========

    let currentPostPedidoId = null;

    function showPostCreation(pedidoId) {
        currentPostPedidoId = pedidoId;
        document.getElementById('postPedidoId').textContent = pedidoId;
        document.getElementById('postCreationSection').style.display = 'block';
        loadPostAdjuntos(pedidoId);
        loadPostComentarios(pedidoId);
        setupPostListeners(pedidoId);
        // Scroll to section
        setTimeout(() => document.getElementById('postCreationSection').scrollIntoView({behavior:'smooth'}), 300);
    }

    function setupPostListeners(pedidoId) {
        // Upload file
        document.getElementById('btnPostAddFile').onclick = () => document.getElementById('postAdjuntoInput').click();
        document.getElementById('postAdjuntoInput').onchange = async (e) => {
            const files = e.target.files;
            if (!files.length) return;
            const status = document.getElementById('postAdjuntoStatus');
            for (const file of files) {
                status.textContent = `Subiendo ${file.name}...`;
                try {
                    const token = getToken();
                    const fd = new FormData();
                    fd.append('archivo', file);
                    const res = await fetch(API_BASE + '/pedidos/' + pedidoId + '/adjuntos', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + token },
                        body: fd
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Error');
                } catch (err) {
                    showError(`Error subiendo ${file.name}: ${err.message}`);
                }
            }
            status.textContent = '';
            e.target.value = '';
            loadPostAdjuntos(pedidoId);
        };

        // Add comment
        document.getElementById('btnPostAddComment').onclick = async () => {
            const input = document.getElementById('postNuevoComentario');
            const texto = input.value.trim();
            if (!texto) return;
            input.disabled = true;
            try {
                await apiFetch('/pedidos/' + pedidoId + '/comentarios', {
                    method: 'POST',
                    body: JSON.stringify({ texto })
                });
                input.value = '';
                loadPostComentarios(pedidoId);
            } catch (e) {
                showError(e.message);
            }
            input.disabled = false;
        };

        document.getElementById('postNuevoComentario').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') document.getElementById('btnPostAddComment').click();
        });
    }

    async function loadPostAdjuntos(pedidoId) {
        const container = document.getElementById('postAdjuntosLista');
        try {
            const adjuntos = await apiFetch('/pedidos/' + pedidoId + '/adjuntos');
            if (!adjuntos || adjuntos.length === 0) { container.innerHTML = '<p style="color:#999;font-size:.9em;">Sin adjuntos</p>'; return; }
            function ico(m) { if (!m) return 'fa-file'; if (m.includes('image')) return 'fa-image'; if (m.includes('pdf')) return 'fa-file-pdf'; if (m.includes('video')) return 'fa-video'; return 'fa-file'; }
            function sz(b) { if (!b) return ''; if (b<1024) return b+' B'; if (b<1048576) return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }
            container.innerHTML = adjuntos.map(a => `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:#f8f9fa;border-radius:8px;margin-bottom:6px;">
                <i class="fas ${ico(a.tipo_mime)}" style="color:#667eea;font-size:1.1em;width:18px;text-align:center;"></i>
                <div style="flex:1;min-width:0;"><div style="font-size:.9em;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${a.nombre_original}</div><div style="font-size:.75em;color:#999;">${sz(a.tamano_bytes)}</div></div>
                <button onclick="postDescargarAdj('${a.id}')" style="background:none;border:none;cursor:pointer;color:#667eea;" title="Descargar"><i class="fas fa-download"></i></button>
                <button onclick="postEliminarAdj('${a.id}')" style="background:none;border:none;cursor:pointer;color:#dc3545;font-size:.9em;" title="Eliminar"><i class="fas fa-trash"></i></button>
            </div>`).join('');
        } catch (e) { container.innerHTML = '<p style="color:#dc3545;font-size:.85em;">Error cargando adjuntos</p>'; }
    }

    async function loadPostComentarios(pedidoId) {
        const container = document.getElementById('postComentariosLista');
        try {
            const comentarios = await apiFetch('/pedidos/' + pedidoId + '/comentarios');
            if (!comentarios || comentarios.length === 0) { container.innerHTML = '<p style="color:#999;font-size:.9em;">Sin comentarios</p>'; return; }
            container.innerHTML = comentarios.map(c => {
                const fecha = c.created_at ? new Date(c.created_at).toLocaleString('es-DO', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
                return `<div style="padding:10px 12px;background:#f8f9fa;border-radius:8px;margin-bottom:6px;border-left:3px solid #667eea;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <span style="font-weight:600;font-size:.85em;color:#667eea;">${c.autor_nombre}</span>
                        <div style="display:flex;align-items:center;gap:6px;">
                            <span style="font-size:.72em;color:#999;">${fecha}</span>
                            <button onclick="postEliminarCom('${c.id}')" style="background:none;border:none;cursor:pointer;color:#dc3545;font-size:.75em;" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div style="font-size:.9em;">${c.texto}</div>
                </div>`;
            }).join('');
        } catch (e) { container.innerHTML = '<p style="color:#dc3545;font-size:.85em;">Error cargando comentarios</p>'; }
    }

    // Global handlers for formulario
    window.postDescargarAdj = async (adjId) => {
        try {
            const res = await apiFetch('/adjuntos/' + adjId + '/download');
            if (res && res.url) { window.open(res.url, '_blank'); }
        } catch (e) { showError(e.message); }
    };

    window.postEliminarAdj = async (adjId) => {
        if (!confirm('¬øEliminar este archivo?')) return;
        try {
            await apiFetch('/adjuntos/' + adjId, { method: 'DELETE' });
            if (currentPostPedidoId) loadPostAdjuntos(currentPostPedidoId);
        } catch (e) { showError(e.message); }
    };

    window.postEliminarCom = async (comId) => {
        if (!confirm('¬øEliminar este comentario?')) return;
        try {
            await apiFetch('/comentarios/' + comId, { method: 'DELETE' });
            if (currentPostPedidoId) loadPostComentarios(currentPostPedidoId);
        } catch (e) { showError(e.message); }
    };
})();
</script>
</body>
</html>
