<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Shogun</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .login-container{background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);width:100%;max-width:450px;overflow:hidden}
        .login-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:40px 30px;text-align:center}
        .login-header h1{font-size:2em;margin-bottom:10px}
        .login-header p{opacity:.9}
        .login-body{padding:40px 30px}
        .form-group{margin-bottom:25px}
        .form-label{display:block;font-weight:600;margin-bottom:8px}
        .input-wrapper{position:relative}
        .input-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:#999}
        .form-control{width:100%;padding:14px 16px 14px 45px;border:2px solid #e0e0e0;border-radius:10px;font-size:1em}
        .form-control:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}
        .btn-login{width:100%;padding:16px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:10px;font-size:1.1em;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:opacity .3s}
        .btn-login:hover{opacity:.9}
        .btn-login:disabled{opacity:.6;cursor:not-allowed}
        .alert{display:none;padding:14px 16px;border-radius:10px;margin-bottom:20px;align-items:center;gap:10px}
        .alert.show{display:flex}
        .alert-error{background:#fee;color:#c33;border-left:4px solid #c33}
        .loading-spinner{width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
<div class="login-container">
    <div class="login-header">
        <h1>ü™° Shogun Sistema</h1>
        <p>Gesti√≥n de Ventas</p>
    </div>
    <div class="login-body">
        <div id="alert" class="alert alert-error">
            <i class="fas fa-exclamation-circle"></i>
            <span id="alertMessage"></span>
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label class="form-label">Email</label>
                <div class="input-wrapper">
                    <i class="fas fa-envelope input-icon"></i>
                    <input type="email" id="email" class="form-control" placeholder="tu@email.com" required autocomplete="email">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Contrase√±a</label>
                <div class="input-wrapper">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" id="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                </div>
            </div>
            <button type="submit" class="btn-login" id="btnLogin">
                <i class="fas fa-sign-in-alt"></i>
                <span>Iniciar sesi√≥n</span>
            </button>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/config.js"></script>
<script>
(function() {
    const API_BASE = window.API_BASE;
    const form = document.getElementById('loginForm');
    const alertBox = document.getElementById('alert');
    const alertMsg = document.getElementById('alertMessage');
    const btn = document.getElementById('btnLogin');

    const supabaseClient = window.initSupabase();

    // Check existing session
    (async () => {
        const token = localStorage.getItem('sb_access_token');
        if (!token) return;
        try {
            const res = await fetch(API_BASE + '/verify', { headers: { 'Authorization': 'Bearer ' + token } });
            if (res.ok) window.location.href = '/backoffice';
            else { localStorage.removeItem('sb_access_token'); localStorage.removeItem('sb_refresh_token'); localStorage.removeItem('user'); }
        } catch(e) {}
    })();

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        alertBox.classList.remove('show');

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        if (!email || !password) { showError('Completa todos los campos.'); return; }

        btn.disabled = true;
        btn.innerHTML = '<div class="loading-spinner"></div> <span>Verificando...</span>';

        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) throw new Error(error.message === 'Invalid login credentials' ? 'Credenciales incorrectas.' : error.message);

            const response = await fetch(API_BASE + '/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + data.session.access_token }
            });
            const result = await response.json();
            if (!response.ok || !result.success) throw new Error(result.error || 'No autorizado');

            localStorage.setItem('sb_access_token', data.session.access_token);
            localStorage.setItem('sb_refresh_token', data.session.refresh_token);
            localStorage.setItem('user', JSON.stringify(result.user));
            window.location.href = '/backoffice';
        } catch (err) {
            showError(err.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> <span>Iniciar sesi√≥n</span>';
        }
    });

    function showError(msg) { alertMsg.textContent = msg; alertBox.classList.add('show'); }
})();
</script>
</body>
</html>
